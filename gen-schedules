#!/bin/bash

set -e

jobs=0

export AWK_STRIPPER="$(readlink -e stripper.awk)"
alliance_lengths="$(seq 2 4)"

if [ ! -n "$AWK" ]; then
    AWK=awk
fi

schedule_it() {
    # $1 = rounds
    # $2 = alliance size
    # $3 = team count
    if [ "$3" -ge "$(($2 * 2))" ]; then
        set -x
        outfile_basename="${2}v${2}/${3}_${2}v${2}"

        echo "making schedule '${outfile_basename}.txt'..."

        MatchMaker -a "$2" -r "$1" -t "$3" -b > "${outfile_basename}.txt"

        awk -f "$AWK_STRIPPER" "${outfile_basename}.txt"

        mv "${outfile_basename}.csv" out/
    else
        echo "Cannot generate a schedule with $3 ships with alliance length $2!"
        
        exit 1
    fi
}

export -f schedule_it


if [ ! -d schedules ]; then
    echo "creating 'schedules' directory"
    mkdir schedules
fi

cd schedules

if [ ! -d out ]; then
    echo "creating 'schedules/out' directory"
    mkdir out
fi

if [ "$(ls -A out/)" ]; then
    rm out/*
fi

for i in $alliance_lengths; do
    DIRNAME="${i}v${i}"
    
    if [ ! -d "${DIRNAME}" ]; then
        mkdir "${DIRNAME}"
    else
        if [ "$(ls -A out/)" ]; then
            rm "${DIRNAME}"/*
        fi
    fi

    cd "./${DIRNAME}"
    

    # for j in $(seq $(expr "$i" '*' '2') $2); do

    #     if [ $jobs -ge 14 ]; then
    #         wait -n
    #         let 'jobs -= 1'
    #     fi

    #     schedule_it "$1" "$i" "$j" &
    #     let 'jobs += 1'
    # done
    
    cd ..
done

parallel schedule_it {1} {2} {3} ::: $1 ::: $alliance_lengths ::: $(seq 1 100)

